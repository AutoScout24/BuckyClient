/*! bucky 0.2.0 */
(function(){var a,b,c,d,e,f=[].slice;e=null!=("undefined"!=typeof process&&null!==process?process.hrtime:void 0)?function(){var a;return a=process.hrtime(),1e3*(a[0]+a[1]/1e9)}:function(){var a,b;return null!=(a=null!=(b=window.performance)?"function"==typeof b.now?b.now():void 0:void 0)?a:+new Date},c=+new Date,b=function(){var a,b,c,d,e,g,h,i;for(a=arguments[0],d=2<=arguments.length?f.call(arguments,1):[],i=d.reverse(),g=0,h=i.length;h>g;g++){c=i[g];for(b in c)e=c[b],a[b]=e}return a},d=function(){var a,b;return a=1<=arguments.length?f.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console?null!=(b=console.log)?b.call:void 0:void 0)?console.log.apply(console,a):void 0},d.error=function(){var a,b;return a=1<=arguments.length?f.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console?null!=(b=console.error)?b.call:void 0:void 0)?console.error.apply(console,a):void 0},a=function(){var a,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;return k={host:"/bucky",maxInterval:3e4,aggregationInterval:5e3,decimalPrecision:3,sendLatency:!1,sample:1,active:!0},r=b({},k),h={timer:"ms",gauge:"g",counter:"c"},a=r.active,(x=function(){return a=r.active&&Math.random()<r.sample})(),g=[],w=function(a){return b(r,a),("sample"in a||"active"in a)&&x(),r},t=function(a,b){return null==b&&(b=r.decimalPrecision),a.toFixed(b)},s={},l=function(b,c,d){var e,f;if(a)return e=1,b in s&&("counter"===d?c+=s[b].value:(e=null!=(f=s[b].count)?f:e,e++,c=s[b].value+(c-s[b].value)/e)),s[b]={value:c,type:d,count:e},i()},v=null,q=null,m=function(){return clearTimeout(v),clearTimeout(q),q=null,v=null,u()},i=function(){return clearTimeout(v),v=setTimeout(m,r.aggregationInterval),null==q?q=setTimeout(m,r.maxInterval):void 0},p=function(a){var b,c,d,f,g,h,i;return c=window.XMLHttpRequest&&(XMLHttpRequest.defake||"withCredentials"in new XMLHttpRequest),d=/^(https?:\/\/[^\/]+)/i.exec(r.host),d?(f=d[1],h=f===""+document.location.protocol+"//"+document.location.host?!0:!1):h=!0,i=e(),b=JSON.stringify(a),g=h||c||null==window.XDomainRequest?new XMLHttpRequest:new XDomainRequest,g.bucky={track:!1},g.open("POST",""+r.host+"/send",!0),null!=window.XDomainRequest&&g instanceof XDomainRequest?g.setRequestHeader("Content-Type","text/plain"):g.setRequestHeader("Content-Type","application/json"),g.addEventListener("load",function(){return y(e()-i)},!1),g.send(b),g},u=function(){var b,c,e,f,i;if(!a)return d("Would send bucky queue"),void 0;c={};for(b in s)e=s[b],g.push({path:b,count:e.count,type:e.type,value:e.value}),null!=h[e.type]?(f=e.value,("gauge"===(i=e.type)||"timer"===i)&&(f=t(f)),c[b]=""+f+"|"+h[e.type],1!==e.count&&(c[b]+="@"+t(1/e.count,5))):d.error("Type "+e.type+" not understood by Bucky");return p(c),s={}},j=0,n=!1,y=function(a){return j=a,r.sendLatency&&!n?(l("bucky.latency",a,"timer"),n=!0,setTimeout(function(){return n=!1},3e5)):void 0},o=function(b){var h,i,j,k,n,p,q,s,t,u,v;null==b&&(b=""),h=function(a){return null!=b?b.length:void 0,a},q=function(a,b,c){return null==c&&(c="gauge"),l(h(a),b,c)},u={TIMES:{},send:function(a,b){return q(a,b,"timer")},time:function(){var a,b,c,d,e;return e=arguments[0],a=arguments[1],c=arguments[2],b=4<=arguments.length?f.call(arguments,3):[],u.start(e),d=function(){return u.stop(e)},b.splice(0,0,d),a.apply(c,b)},timeSync:function(){var a,b,c,d,e;return d=arguments[0],a=arguments[1],c=arguments[2],b=4<=arguments.length?f.call(arguments,3):[],u.start(d),e=a.apply(c,b),u.stop(d),e},wrap:function(a,b){return null!=b?function(){var c;return c=1<=arguments.length?f.call(arguments,0):[],u.timeSync.apply(u,[a,b,this].concat(f.call(c)))}:function(b){return function(){var c;return c=1<=arguments.length?f.call(arguments,0):[],u.timeSync.apply(u,[a,b,this].concat(f.call(c)))}}},start:function(a){return u.TIMES[a]=e()},stop:function(a){var b;return null==u.TIMES[a]?(d.error("Timer "+a+" ended without having been started"),void 0):(b=e()-u.TIMES[a],u.TIMES[a]=void 0,u.send(a,b))},stopwatch:function(a,b){var c,d;return null!=b?d=function(){return+new Date}:(d=e,b=d()),c=b,{mark:function(c,e){var f;return null==e&&(e=0),f=d(),a&&(c=a+"."+c),u.send(c,f-b+e)},split:function(b,e){var f;return null==e&&(e=0),f=d(),a&&(b=a+"."+b),u.send(b,f-c+e),c=f}}},mark:function(a,b){var c;return null==b&&(b=+new Date),c=u.navigationStart(),u.send(a,b-c)},navigationStart:function(){var a,b,d;return null!=(a="undefined"!=typeof window&&null!==window?null!=(b=window.performance)?null!=(d=b.timing)?d.navigationStart:void 0:void 0:void 0)?a:c},responseEnd:function(){var a,b,d;return null!=(a="undefined"!=typeof window&&null!==window?null!=(b=window.performance)?null!=(d=b.timing)?d.responseEnd:void 0:void 0:void 0)?a:c},now:function(){return e()}},i=function(a,b){return null==b&&(b=1),q(a,b,"counter")},t=!1,s=function(a){var b,c,d,e,f,g;if(null==a&&(a="timing"),null==("undefined"!=typeof window&&null!==window?null!=(e=window.performance)?e.timing:void 0:void 0))return!1;if(t)return!1;if("uninitialized"===(f=document.readyState)||"loading"===f)return"function"==typeof document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){return s.apply(this,arguments)},!1),!1;t=!0,c=window.performance.timing.navigationStart,g=window.performance.timing;for(b in g)d=g[b],d&&u.send(""+a+"."+b,d-c);return!0},p={transforms:{mapping:{guid:/\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,sha1:/\/[0-9a-f]{40}/gi,md5:/\/[0-9a-f]{32}/gi,id:/\/[0-9;_\-]+/g,email:/\/[^/]+@[^/]+/g,domain:/\/[^/]+\.[a-z]{2,3}/gi},enabled:["guid","sha1","md5","id","email","domain"],enable:function(a,b,c){return null==c&&(c=""),null!=b&&(this.mapping[a]=[b,c]),this.enabled.splice(0,0,a)},disable:function(a){var b,c,d;d=this.enabled;for(c in d)if(b=d[c],c===a)return this.enabled.splice(b,1),void 0}},sendReadyStateTimes:function(a,b){var c,d,e,f,g,h,i,j;if(null!=b){d={1:"sending",2:"headers",3:"waiting",4:"receiving"},e={},f=null;for(c in b)h=b[c],null!=f&&null!=d[c]&&(e[d[c]]=h-f),f=h;j=[];for(g in e)i=e[g],j.push(u.send(""+a+"."+g,i));return j}},urlToKey:function(a,b,c){var e,f,g,h,i,j,k,l,m,n;for(a=a.replace(/https?:\/\//i,""),h=/([^/:]*)(?::\d+)?(\/[^\?#]*)?.*/i.exec(a),e=h[1],i=null!=(m=h[2])?m:"",n=p.transforms.enabled,k=0,l=n.length;l>k;k++)g=n[k],f=p.transforms.mapping[g],null!=f?"function"!=typeof f?(f instanceof RegExp&&(f=[f,""]),i=i.replace(f[0],f[1])):i=f(i,a,b,c):d.error("Bucky Error: Attempted to enable a mapping which is not defined: "+g);return i=decodeURIComponent(i),i=i.replace(/[^a-zA-Z0-9\-\.\/ ]+/g,"_"),j=e+i.replace(/[\/ ]/g,"."),j=j.replace(/(^\.)|(\.$)/g,""),j=j.replace(/\.com/,""),j=j.replace(/www\./,""),c&&(j=c+"."+j),b&&(j=j+"."+b.toLowerCase()),j=j.replace(/\.\./g,".")},getFullUrl:function(a,b){return null==b&&(b=document.location),/^\//.test(a)?b.hostname+a:/https?:\/\//i.test(a)?a:b.toString()+a},monitor:function(a){var b,c,f;return null==a&&(a="requests"),c=this,b=function(b){var d,f,g,h,j,k,l;return k=b.type,l=b.url,f=b.event,g=b.request,h=b.startTime,null!=h?(d=e()-h,l=c.getFullUrl(l),j=c.urlToKey(l,k,a),q(j,d,"timer"),c.sendReadyStateTimes(j,readyStateTimes),null!=(null!=g?g.status:void 0)?(g.status>12e3?i(""+j+".0"):0!==g.status&&i(""+j+"."+g.status.toString().charAt(0)+"xx"),i(""+j+"."+g.status)):void 0):void 0},f=window.XMLHttpRequest,window.XMLHttpRequest=function(){var a,c,g,h,i,j;g=new f;try{h=null,c={},i=g.open,g.open=function(a,f){var j;try{c[0]=e(),g.addEventListener("readystatechange",function(){return c[g.readyState]=e()},!1),g.addEventListener("loadend",function(d){return null==g.bucky||g.bucky.track!==!1?b({type:a,url:f,event:d,startTime:h,readyStateTimes:c,request:g}):void 0},!1)}catch(k){j=k,d.error("Bucky error monitoring XHR open call",j)}return i.apply(g,arguments)},j=g.send,g.send=function(){return h=e(),j.apply(g,arguments)}}catch(k){a=k,d.error("Bucky error monitoring XHR",a)}return g}}},n=function(a){var c;return null==a&&(a=""),c=null!=b?b:"",c&&a&&(c+="."),a&&(c+=a),o(c)},j={send:q,count:i,timer:u,now:e,requests:p,sendPerformanceData:s,flush:m,setOptions:w,options:r,history:g,active:a,enableAjaxMonitoring:function(){return p.monitor.apply(p,arguments)}};for(k in j)v=j[k],n[k]=v;return n},o()},"function"==typeof define&&define.amd?define(a):"object"==typeof exports?module.exports=a():window.Bucky=a()}).call(this);