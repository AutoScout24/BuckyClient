/*! bucky 0.2.1 */
(function(){var a,b,c,d,e,f,g,h=[].slice;e="undefined"!=typeof module&&null!==module&&!("undefined"!=typeof window&&null!==window?window.module:void 0),e?(a=require("xmlhttprequest").XMLHttpRequest,g=function(){var a;return a=process.hrtime(),1e3*(a[0]+a[1]/1e9)}):(a=window.XMLHttpRequest,g=function(){var a,b;return null!=(a=null!=(b=window.performance)?"function"==typeof b.now?b.now():void 0:void 0)?a:+new Date}),d=+new Date,c=function(){var a,b,c,d,e,f,g,i;for(a=arguments[0],d=2<=arguments.length?h.call(arguments,1):[],i=d.reverse(),f=0,g=i.length;g>f;f++){c=i[f];for(b in c)e=c[b],a[b]=e}return a},f=function(){var a,b;return a=1<=arguments.length?h.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console?null!=(b=console.log)?b.call:void 0:void 0)?console.log.apply(console,a):void 0},f.error=function(){var a,b;return a=1<=arguments.length?h.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console?null!=(b=console.error)?b.call:void 0:void 0)?console.error.apply(console,a):void 0},b=function(){var b,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;return m={host:"/bucky",maxInterval:3e4,aggregationInterval:5e3,decimalPrecision:3,sendLatency:!1,sample:1,active:!0},t=c({},m),j={timer:"ms",gauge:"g",counter:"c"},b=t.active,(z=function(){return b=t.active&&Math.random()<t.sample})(),i=[],y=function(a){return c(t,a),("sample"in a||"active"in a)&&z(),t},v=function(a,b){return null==b&&(b=t.decimalPrecision),Math.round(a*Math.pow(10,b))/Math.pow(10,b)},u={},n=function(a,c,d){var e,f;if(b)return e=1,a in u&&("counter"===d?c+=u[a].value:(e=null!=(f=u[a].count)?f:e,e++,c=u[a].value+(c-u[a].value)/e)),u[a]={value:c,type:d,count:e},k()},x=null,s=null,o=function(){return clearTimeout(x),clearTimeout(s),s=null,x=null,w()},k=function(){return clearTimeout(x),x=setTimeout(o,t.aggregationInterval),null==s?s=setTimeout(o,t.maxInterval):void 0},r=function(b){var c,d,f,h,i,j,k,l,m;d=e||a&&(a.defake||"withCredentials"in new a),e?k=!0:(f=/^(https?:\/\/[^\/]+)/i.exec(t.host),f?(i=f[1],k=i===""+document.location.protocol+"//"+document.location.host?!0:!1):k=!0),l=g(),c="";for(h in b)m=b[h],c+=""+h+":"+m+"\n";return j=k||d||null==("undefined"!=typeof window&&null!==window?window.XDomainRequest:void 0)?new a:new window.XDomainRequest,j.bucky={track:!1},j.open("POST",""+t.host+"/v1/send",!0),j.setRequestHeader("Content-Type","text/plain"),j.addEventListener("load",function(){return A(g()-l)},!1),j.send(c),j},w=function(){var a,c,d,e,g;if(!b)return f("Would send bucky queue"),void 0;c={};for(a in u)d=u[a],i.push({path:a,count:d.count,type:d.type,value:d.value}),null!=j[d.type]?(e=d.value,("gauge"===(g=d.type)||"timer"===g)&&(e=v(e)),c[a]=""+e+"|"+j[d.type],1!==d.count&&(c[a]+="@"+v(1/d.count,5))):f.error("Type "+d.type+" not understood by Bucky");return r(c),u={}},l=0,p=!1,A=function(a){return l=a,t.sendLatency&&!p?(n("bucky.latency",a,"timer"),p=!0,setTimeout(function(){return p=!1},3e5)):void 0},q=function(a){var c,e,j,k,l,m,p,r,s,u,v;null==a&&(a=""),c=function(b){return null!=a?a.length:void 0,b},p=function(a,b,d){return null==d&&(d="gauge"),null==b||null==a?(f.error("Can't log "+a+":"+b),void 0):n(c(a),b,d)},u={TIMES:{},send:function(a,b){return p(a,b,"timer")},time:function(){var a,b,c,d,e;return e=arguments[0],a=arguments[1],c=arguments[2],b=4<=arguments.length?h.call(arguments,3):[],u.start(e),d=function(){return u.stop(e)},b.splice(0,0,d),a.apply(c,b)},timeSync:function(){var a,b,c,d,e;return d=arguments[0],a=arguments[1],c=arguments[2],b=4<=arguments.length?h.call(arguments,3):[],u.start(d),e=a.apply(c,b),u.stop(d),e},wrap:function(a,b){return null!=b?function(){var c;return c=1<=arguments.length?h.call(arguments,0):[],u.timeSync.apply(u,[a,b,this].concat(h.call(c)))}:function(b){return function(){var c;return c=1<=arguments.length?h.call(arguments,0):[],u.timeSync.apply(u,[a,b,this].concat(h.call(c)))}}},start:function(a){return u.TIMES[a]=g()},stop:function(a){var b;return null==u.TIMES[a]?(f.error("Timer "+a+" ended without having been started"),void 0):(b=g()-u.TIMES[a],u.TIMES[a]=void 0,u.send(a,b))},stopwatch:function(a,b){var c,d;return null!=b?d=function(){return+new Date}:(d=g,b=d()),c=b,{mark:function(c,e){var f;return null==e&&(e=0),f=d(),a&&(c=a+"."+c),u.send(c,f-b+e)},split:function(b,e){var f;return null==e&&(e=0),f=d(),a&&(b=a+"."+b),u.send(b,f-c+e),c=f}}},mark:function(a,b){var c;return null==b&&(b=+new Date),c=u.navigationStart(),u.send(a,b-c)},navigationStart:function(){var a,b,c;return null!=(a="undefined"!=typeof window&&null!==window?null!=(b=window.performance)?null!=(c=b.timing)?c.navigationStart:void 0:void 0:void 0)?a:d},responseEnd:function(){var a,b,c;return null!=(a="undefined"!=typeof window&&null!==window?null!=(b=window.performance)?null!=(c=b.timing)?c.responseEnd:void 0:void 0:void 0)?a:d},now:function(){return g()}},e=function(a,b){return null==b&&(b=1),p(a,b,"counter")},s=!1,r=function(a){var b,c,d,e,f,g,h=this;if(null==a&&(a="timing"),null==("undefined"!=typeof window&&null!==window?null!=(e=window.performance)?e.timing:void 0:void 0))return!1;if(s)return!1;if("uninitialized"===(f=document.readyState)||"loading"===f)return"function"==typeof document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){return r.call(h,a)},!1),!1;s=!0,c=window.performance.timing.navigationStart,g=window.performance.timing;for(b in g)d=g[b],d&&u.send(""+a+"."+b,d-c);return!0},m={transforms:{mapping:{guid:/\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,sha1:/\/[0-9a-f]{40}/gi,md5:/\/[0-9a-f]{32}/gi,id:/\/[0-9;_\-]+/g,email:/\/[^/]+@[^/]+/g,domain:/\/[^/]+\.[a-z]{2,3}/gi},enabled:["guid","sha1","md5","id","email","domain"],enable:function(a,b,c){return null==c&&(c=""),null!=b&&(this.mapping[a]=[b,c]),this.enabled.splice(0,0,a)},disable:function(a){var b,c,d;d=this.enabled;for(c in d)if(b=d[c],c===a)return this.enabled.splice(b,1),void 0}},sendReadyStateTimes:function(a,b){var c,d,e,f,g,h,i,j;if(null!=b){d={1:"sending",2:"headers",3:"waiting",4:"receiving"},e={},f=null;for(c in b)h=b[c],null!=f&&null!=d[c]&&(e[d[c]]=h-f),f=h;j=[];for(g in e)i=e[g],j.push(u.send(""+a+"."+g,i));return j}},urlToKey:function(a,b,c){var d,e,g,h,i,j,k,l,n,o;for(a=a.replace(/https?:\/\//i,""),h=/([^/:]*)(?::\d+)?(\/[^\?#]*)?.*/i.exec(a),d=h[1],i=null!=(n=h[2])?n:"",o=m.transforms.enabled,k=0,l=o.length;l>k;k++)g=o[k],e=m.transforms.mapping[g],null!=e?"function"!=typeof e?(e instanceof RegExp&&(e=[e,""]),i=i.replace(e[0],e[1])):i=e(i,a,b,c):f.error("Bucky Error: Attempted to enable a mapping which is not defined: "+g);return i=decodeURIComponent(i),i=i.replace(/[^a-zA-Z0-9\-\.\/ ]+/g,"_"),j=d+i.replace(/[\/ ]/g,"."),j=j.replace(/(^\.)|(\.$)/g,""),j=j.replace(/\.com/,""),j=j.replace(/www\./,""),c&&(j=c+"."+j),b&&(j=j+"."+b.toLowerCase()),j=j.replace(/\.\./g,".")},getFullUrl:function(a,b){return null==b&&(b=document.location),/^\//.test(a)?b.hostname+a:/https?:\/\//i.test(a)?a:b.toString()+a},monitor:function(a){var b,c,d;return null==a&&(a="requests"),c=this,b=function(b){var d,f,h,i,j,k,l;return k=b.type,l=b.url,f=b.event,h=b.request,i=b.startTime,null!=i?(d=g()-i,l=c.getFullUrl(l),j=c.urlToKey(l,k,a),p(j,d,"timer"),c.sendReadyStateTimes(j,readyStateTimes),null!=(null!=h?h.status:void 0)?(h.status>12e3?e(""+j+".0"):0!==h.status&&e(""+j+"."+h.status.toString().charAt(0)+"xx"),e(""+j+"."+h.status)):void 0):void 0},d=window.XMLHttpRequest,window.XMLHttpRequest=function(){var a,c,e,h,i,j;e=new d;try{h=null,c={},i=e.open,e.open=function(a,d){var j;try{c[0]=g(),e.addEventListener("readystatechange",function(){return c[e.readyState]=g()},!1),e.addEventListener("loadend",function(f){return null==e.bucky||e.bucky.track!==!1?b({type:a,url:d,event:f,startTime:h,readyStateTimes:c,request:e}):void 0},!1)}catch(k){j=k,f.error("Bucky error monitoring XHR open call",j)}return i.apply(e,arguments)},j=e.send,e.send=function(){return h=g(),j.apply(e,arguments)}}catch(k){a=k,f.error("Bucky error monitoring XHR",a)}return e}}},l=function(b){var c;return null==b&&(b=""),c=null!=a?a:"",c&&b&&(c+="."),b&&(c+=b),q(c)},j={send:p,count:e,timer:u,now:g,requests:m,sendPerformanceData:r,flush:o,setOptions:y,options:t,history:i,active:b,enableAjaxMonitoring:function(){return m.monitor.apply(m,arguments)}};for(k in j)v=j[k],l[k]=v;return l},q()},"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():window.Bucky=b()}).call(this);